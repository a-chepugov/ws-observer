<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>websocket</title>
</head>
<body>
<script>
	var origin = location.origin.replace(/^http/, 'ws');
	var socket = new WebSocket(origin);
	window.socket = socket;

	const room = {id: 'bino', secret: '12ss3d'};

	const connection = {id: 0};

	function sendObject(payload) {
		return this.send(JSON.stringify(payload));
	}

	function onConnect(payload) {
		connection.id = payload.id;
		return checkRoomExist({room});
	}

	function checkRoomExist(payload) {
		return sendObject.call(socket, {type: '?room.exist', payload});
	}

	function onRoomExist(payload) {
		return payload ? enterRoom({room, connection}) : createRoom({room});
	}

	function createRoom(payload) {
		return sendObject.call(socket, {type: '?room.create', payload});
	}

	function enterRoom(payload) {
		return sendObject.call(socket, {type: '?room.enter', payload});
	}

	function broadcast(payload) {
		return sendObject.call(socket, {type: '?room.broadcast', payload: Object.assign({message: (new Date()).toISOString()}, payload)});
	}

	function messageHandler(message) {
		switch (message.type) {
			case '!connect':
				// return broadcast({room})
				return onConnect(message.payload);
			case '!room.exist':
				return onRoomExist(message.payload);
			case '!room.create':
			// 	// @todo Абшика тута
				console.log('DEBUG:index.html(messageHandler):53 =>', message);
				return enterRoom(message.payload);
			case '!room.enter':
				console.log('DEBUG:index.html(messageHandler):55 =>', message);
				return message.payload === true ?
					broadcast(Object.assign({room}, {message: (new Date()).toISOString()})) :
					console.error(message.payload);
			case '!room.broadcast':
				return console.log('DEBUG:index.html(messageHandler):61 =>', message.payload);
			default:
				throw new Error('Unknown type: ' + message.type);
		}
	}

	socket.onopen = function (event) {
		socket.onmessage = function (msg) {
			return messageHandler(JSON.parse(msg.data));
		};
	};

</script>
</body>
</html>
