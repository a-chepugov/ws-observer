<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>websocket</title>
</head>
<body>
<script>
	const start = Date.now();

	const origin = location.origin.replace(/^http/, 'ws');
	const socket = new WebSocket(origin);
	window.socket = socket;

	const room = {id: 'test', secret: 'slkdjfgh'};

	const connection = {id: 0, secret: 0};

	function send(payload) {
		return socket.send(JSON.stringify(payload));
	}

	const sendFactory = (type) => (payload, error) => {
		console.info('DEBUG:index.html():24 =>', type, JSON.stringify(payload));
		return send({type, payload, error: error ? error.toString() : undefined})
	};

	function onConnect(message) {
		Object.assign(connection, message.payload);

		setConnectionMeta({connection, meta: {start}});

		return checkRoomExist({room});
	}

	function setConnectionMeta(payload) {
		return sendFactory('?connection.meta')(payload);
	}

	function onConnectionMeta(payload) {
		console.log('DEBUG:index.html(onConnectionMeta):41 =>', arguments);
	}

	function checkRoomExist(payload) {
		return sendFactory('?room.exist')(payload);
	}

	function onRoomExist(message) {
		return message.payload ? enterRoom({room, connection}) : createRoom({room, connection});
	}

	function createRoom(payload) {
		return sendFactory('?room.create')(payload);
	}

	function enterRoom(payload) {
		return sendFactory('?room.enter')(payload);
	}

	function onRoomEnter(message) {
		return getRoomers({room, connection});
	}

	function onRoomNewcomer(message) {
		return sendRoomMessage({room, connection, roomate: message.payload, message: Date.now()});
	}

	function getRoomers(payload) {
		return sendFactory('?room.roomers')(payload);
	}

	function onRoomRoomers(payload) {
		return broadcastInRoom({room, connection, message: Date.now()})
	}

	function broadcastInRoom(payload) {
		return sendFactory('?room.broadcast')(payload);
	}

	function onRoomBroadcast(payload) {
		console.log('DEBUG:index.html(onRoomBroadcast):81 =>', arguments);
	}

	function sendRoomMessage(payload) {
		return sendFactory('?room.message')(payload);
	}

	function onRoomMessage(payload) {
		console.log('DEBUG:index.html(onRoomMessage):89 =>', arguments);
	}

	function onRoomLeave(payload) {
		console.log('DEBUG:index.html(onRoomLeave):93 =>', arguments);
	}

	function messageHandler(message) {
		switch (message.type) {
			case '!connection':
				return onConnect(message);
			case '!connection.meta':
				return onConnectionMeta(message);
			case '!room.exist':
				return onRoomExist(message);
			case '!room.create':
				return onRoomExist(message);
			case '!room.enter':
				return onRoomEnter(message);
			case '!room.broadcast':
				return onRoomBroadcast(message);
			case '!room.roomers':
				return onRoomRoomers(message);
			case '!room.creator':
				return console.info(message);
			case '!room.newcomer':
				return onRoomNewcomer(message);
			case '!room.leaving':
				return onRoomLeave(message);
			case '!room.message':
				return onRoomMessage(message);
			default:
				throw new Error('Unknown type: ' + message.type);
		}
	}

	socket.onopen = function (event) {
		socket.onmessage = function (msg) {
			return messageHandler(JSON.parse(msg.data));
		};
	};

</script>
</body>
</html>
